version: '3.8'

services:
  # ==============================================
  # SERVIÇO OMNeT++ (Network Simulation)
  # ==============================================
  omnet:
    build:
      context: .
      dockerfile: Dockerfile.omnet
    container_name: cosima-omnet
    hostname: omnet-container
    volumes:
      - ./omnetpp_src:/root/omnetpp-5.6.2
      - ./cosima_omnetpp_project:/root/models
      - ./omnet_results:/root/models/results
      - ./logs:/root/logs
    environment:
      - OMNETPP_ROOT=/root/omnetpp-5.6.2
      - PATH=/root/omnetpp-5.6.2/bin:$PATH
      - LD_LIBRARY_PATH=/root/omnetpp-5.6.2/lib
      - INET_PATH=/root/inet4
      - PYTHONPATH=/root/models:/root/models/cosima_core
      - LOGGING_LEVEL=info
    networks:
      cosima-network:
        ipv4_address: 172.20.0.10
    ports:
      - "4242:4242"  # Porta do CosimaScheduler
      - "4243:4243"  # Porta para comunicação bidirecional
    working_dir: /root/models
    stdin_open: true
    tty: true
    command: >
      bash -c "
        echo '=== OMNeT++ COSIMA Simulation Environment ===' &&
        echo 'Configurando ambiente...' &&
        source /root/omnetpp-5.6.2/setenv &&
        echo 'Ambiente pronto. Use: make -j$(nproc)' &&
        echo 'OU para executar simulação:' &&
        echo './run -u Cmdenv -f cosima.ini -c SimpleNetworkTCP' &&
        echo '' &&
        echo 'Para conectar ao MOSAIK na rede:' &&
        echo 'IP: 172.20.0.10 | Hostname: omnet-container' &&
        /bin/bash
      "

  # ==============================================
  # SERVIÇO MOSAIK (Power Grid Simulation)
  # ==============================================
  mosaik:
    build:
      context: .
      dockerfile: Dockerfile.mosaik
    container_name: cosima-mosaik
    hostname: mosaik-container
    volumes:
      - ./mosaik_simulations:/app/mosaik_simulations
      - ./cosima_core:/app/cosima_core
      - ./mosaik_results:/app/results
      - ./logs:/app/logs
    environment:
      - PYTHONPATH=/app:/app/cosima_core
      - OMNET_HOST=omnet-container
      - OMNET_PORT=4242
      - LOGGING_LEVEL=info
    networks:
      cosima-network:
        ipv4_address: 172.20.0.20
    ports:
      - "5000:5000"  # API MOSAIK
    working_dir: /app
    depends_on:
      - omnet
    command: >
      bash -c "
        echo '=== MOSAIK Smart Grid Simulator ===' &&
        echo 'Aguardando OMNeT++...' &&
        sleep 5 &&
        echo 'Testando conexão com OMNeT++...' &&
        if nc -z omnet-container 4242; then
          echo 'Conexão estabelecida com OMNeT++!' &&
          echo '' &&
          echo 'Exemplos disponíveis:' &&
          echo '1. python mosaik_simulations/mosaik_simulation.py' &&
          echo '2. python mosaik_simulations/01_simulators_and_connection_to_omnet.py' &&
          echo '' &&
          echo 'Para executar co-simulação:' &&
          echo 'python 01_simulators_and_connection_to_omnet.py' &&
          echo '' &&
          echo 'IP: 172.20.0.20 | Hostname: mosaik-container' &&
          /bin/bash
        else
          echo 'ERRO: Não foi possível conectar ao OMNeT++ na porta 4242' &&
          echo 'Verifique se o container OMNeT++ está rodando' &&
          /bin/bash
        fi
      "

  # ==============================================
  # SERVIÇO COSIMA CORE (Coordenação)
  # ==============================================
  coordinator:
    build:
      context: .
      dockerfile: Dockerfile.coordinator
    container_name: cosima-coordinator
    hostname: coordinator-container
    volumes:
      - ./cosima_core:/app/cosima_core
      - ./scenarios:/app/scenarios
      - ./coordinator_results:/app/results
      - ./logs:/app/logs
    environment:
      - PYTHONPATH=/app:/app/cosima_core
      - OMNET_HOST=omnet-container
      - OMNET_PORT=4242
      - MOSAIK_HOST=mosaik-container
      - MOSAIK_PORT=5000
      - LOGGING_LEVEL=info
    networks:
      cosima-network:
        ipv4_address: 172.20.0.30
    ports:
      - "8080:8080"  # Dashboard do coordenador
    working_dir: /app
    depends_on:
      - omnet
      - mosaik
    command: >
      bash -c "
        echo '=== COSIMA Co-Simulation Coordinator ===' &&
        echo 'Verificando serviços...' &&
        echo '' &&
        echo '1. Testando OMNeT++...' &&
        if nc -z omnet-container 4242; then
          echo '✓ OMNeT++ disponível' &&
          echo '2. Testando MOSAIK...' &&
          if nc -z mosaik-container 5000; then
            echo '✓ MOSAIK disponível' &&
            echo '' &&
            echo '=== TODOS OS SERVIÇOS PRONTOS ===' &&
            echo 'Para iniciar uma co-simulação:' &&
            echo 'python scenarios/star_topology_scenario.py' &&
            echo '' &&
            echo 'Dashboard disponível em:' &&
            echo 'http://localhost:8080' &&
            echo '' &&
            echo 'IP: 172.20.0.30 | Hostname: coordinator-container' &&
            python -m http.server 8080 --directory /app
          else
            echo '✗ MOSAIK não disponível' &&
            /bin/bash
          fi
        else
          echo '✗ OMNeT++ não disponível' &&
          /bin/bash
        fi
      "

  # ==============================================
  # SERVIÇO MONITORAMENTO (Opcional)
  # ==============================================
  monitor:
    image: grafana/grafana:latest
    container_name: cosima-monitor
    hostname: monitor-container
    volumes:
      - ./grafana_data:/var/lib/grafana
      - ./grafana_dashboards:/etc/grafana/provisioning/dashboards
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=cosima123
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    networks:
      cosima-network:
        ipv4_address: 172.20.0.40
    ports:
      - "3000:3000"  # Grafana
    depends_on:
      - omnet
      - mosaik
    command: >
      bash -c "
        echo '=== COSIMA Monitoring Dashboard ===' &&
        echo 'Acesse: http://localhost:3000' &&
        echo 'Usuário: admin | Senha: cosima123' &&
        /run.sh
      "

  # ==============================================
  # SERVIÇO VERIFICAÇÃO (Utilitário)
  # ==============================================
  checker:
    image: alpine:latest
    container_name: cosima-checker
    hostname: checker-container
    volumes:
      - ./check_cosima.sh:/check_cosima.sh
    networks:
      cosima-network:
    depends_on:
      - omnet
      - mosaik
    command: >
      bash -c "
        echo '=== COSIMA Health Check ===' &&
        chmod +x /check_cosima.sh &&
        /check_cosima.sh
      "

networks:
  cosima-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
